<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KIEROWNIK PRO - System Zarządzania Projektami</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            line-height: 1.6;
            color: #333;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 10px;
        }
        
        /* Header */
        .header {
            background: rgba(255,255,255,0.95);
            padding: 15px 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            backdrop-filter: blur(10px);
        }
        
        .header h1 {
            color: #2d3748;
            font-size: 24px;
            text-align: center;
            margin-bottom: 5px;
        }
        
        .header p {
            text-align: center;
            color: #718096;
            font-size: 14px;
        }
        
        /* Navigation */
        .nav-input {
            display: none;
        }
        
        .main-nav {
            display: flex;
            justify-content: center;
            margin-bottom: 20px;
        }
        
        .main-nav label {
            background: rgba(255,255,255,0.9);
            color: #2d3748;
            padding: 15px 30px;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 3px solid #4facfe;
            font-weight: 700;
            font-size: 16px;
            text-transform: uppercase;
            letter-spacing: 1px;
            box-shadow: 0 6px 20px rgba(79, 172, 254, 0.3);
            margin: 0 10px;
        }
        
        .main-nav label:hover {
            background: rgba(255,255,255,1);
            transform: translateY(-3px);
            box-shadow: 0 10px 30px rgba(79, 172, 254, 0.4);
        }
        
        #nav-dashboard:checked + label {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            border-color: white;
            transform: scale(1.05);
        }
        
        /* Back button */
        .back-btn {
            background: rgba(255,255,255,0.9);
            color: #2d3748;
            padding: 12px 24px;
            border-radius: 20px;
            text-decoration: none;
            font-size: 14px;
            font-weight: 600;
            display: inline-block;
            border: 2px solid rgba(255,255,255,0.5);
            cursor: pointer;
            border: none;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        
        .back-btn:hover {
            background: rgba(255,255,255,1);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.2);
        }
        
        /* Content Sections */
        .section {
            display: none;
            background: rgba(255,255,255,0.95);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            backdrop-filter: blur(10px);
        }
        
        /* Show sections based on navigation */
        #nav-dashboard:checked ~ .content #section-dashboard { display: block; }
        
        /* Dynamic project sections */
        .project-section {
            display: none;
        }
        
        /* Dashboard specific styles */
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .project-card {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            padding: 25px;
            border-radius: 16px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            cursor: pointer;
            transition: all 0.3s ease;
            border: none;
        }
        
        .project-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 40px rgba(0,0,0,0.3);
        }
        
        .project-card h3 {
            font-size: 20px;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .project-card.imported {
            background: linear-gradient(135deg, #56ab2f 0%, #a8e6cf 100%);
        }
        
        .project-status {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            margin-bottom: 15px;
        }
        
        .status-active {
            background: rgba(34, 197, 94, 0.2);
            color: #16a34a;
            border: 1px solid rgba(34, 197, 94, 0.3);
        }
        
        .status-planning {
            background: rgba(251, 191, 36, 0.2);
            color: #d97706;
            border: 1px solid rgba(251, 191, 36, 0.3);
        }
        
        .status-imported {
            background: rgba(34, 197, 94, 0.2);
            color: #16a34a;
            border: 1px solid rgba(34, 197, 94, 0.3);
        }
        
        .project-info {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 20px;
            font-size: 14px;
        }
        
        .info-item {
            display: flex;
            flex-direction: column;
        }
        
        .info-label {
            opacity: 0.8;
            font-size: 12px;
            margin-bottom: 2px;
        }
        
        .info-value {
            font-weight: 600;
            font-size: 16px;
        }
        
        .quick-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .quick-action {
            background: rgba(255,255,255,0.2);
            color: white;
            padding: 8px 12px;
            border-radius: 20px;
            text-decoration: none;
            font-size: 12px;
            font-weight: 600;
            transition: all 0.3s ease;
            border: 1px solid rgba(255,255,255,0.3);
        }
        
        .quick-action:hover {
            background: rgba(255,255,255,0.3);
            transform: translateY(-2px);
        }
        
        /* Project Navigation */
        .project-nav {
            display: none;
            background: rgba(255,255,255,0.15);
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            border: 2px solid rgba(255,255,255,0.3);
        }
        
        .nav-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(130px, 1fr));
            gap: 12px;
        }
        
        .nav-grid label, .nav-grid button {
            background: rgba(255,255,255,0.25);
            color: white;
            padding: 15px 16px;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 13px;
            font-weight: 600;
            border: 3px solid transparent;
            text-align: center;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        
        .nav-grid label:hover, .nav-grid button:hover {
            background: rgba(255,255,255,0.4);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.2);
        }
        
        /* Section tiles */
        .section-tiles {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 20px;
        }
        
        .section-tile {
            background: #f8fafc;
            padding: 25px;
            border-radius: 15px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 4px solid transparent;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        
        .section-tile:hover {
            background: #e2e8f0;
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }
        
        /* Form styles */
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #2d3748;
        }
        
        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s ease;
        }
        
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            outline: none;
            border-color: #4facfe;
        }
        
        .btn {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-right: 10px;
            margin-bottom: 10px;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(79, 172, 254, 0.4);
        }
        
        .btn-secondary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        .btn-success {
            background: linear-gradient(135deg, #56ab2f 0%, #a8e6cf 100%);
        }
        
        .btn-warning {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }
        
        /* Timer specific styles */
        .timer-container {
            display: grid;
            gap: 20px;
        }
        
        .timer-display {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            padding: 30px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        
        .timer-time {
            font-size: 48px;
            font-weight: 700;
            margin: 20px 0;
            font-family: 'Courier New', monospace;
        }
        
        .timer-status {
            font-size: 18px;
            margin-bottom: 15px;
            opacity: 0.9;
        }
        
        .timer-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 20px;
        }
        
        .timer-btn {
            background: rgba(255,255,255,0.2);
            color: white;
            border: 2px solid rgba(255,255,255,0.3);
            padding: 12px 24px;
            border-radius: 25px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .timer-btn:hover:not(:disabled) {
            background: rgba(255,255,255,0.3);
            transform: translateY(-2px);
        }
        
        .timer-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .timer-btn.active {
            background: rgba(255,255,255,0.9);
            color: #2d3748;
        }
        
        .project-selector {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
        }
        
        .project-selector h3 {
            color: #2d3748;
            margin-bottom: 20px;
            font-size: 18px;
        }
        
        .task-history {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
        }
        
        .history-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 0;
            border-bottom: 1px solid #e2e8f0;
        }
        
        .history-item:last-child {
            border-bottom: none;
        }
        
        .task-info {
            flex: 1;
        }
        
        .task-name {
            font-weight: 600;
            color: #2d3748;
            margin-bottom: 5px;
        }
        
        .task-details {
            font-size: 12px;
            color: #718096;
        }
        
        .task-duration {
            font-weight: 600;
            color: #4facfe;
            font-size: 16px;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        
        .stat-item {
            background: #f8fafc;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
        }
        
        .stat-value {
            font-size: 24px;
            font-weight: 700;
            color: #2d3748;
            margin-bottom: 5px;
        }
        
        .stat-label {
            font-size: 12px;
            color: #718096;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        /* Import/Export styles */
        .import-section {
            background: #e0f2fe;
            border: 2px solid #0ea5e9;
            border-radius: 12px;
            padding: 20px;
            margin: 20px 0;
        }
        
        .import-section h4 {
            color: #0369a1;
            margin-bottom: 15px;
        }
        
        .import-instructions {
            color: #0c4a6e;
            margin-bottom: 15px;
            line-height: 1.6;
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .container {
                padding: 5px;
            }
            
            .main-nav {
                flex-direction: column;
                align-items: center;
            }
            
            .main-nav label {
                margin: 5px 0;
                min-width: 200px;
                text-align: center;
            }
            
            .timer-time {
                font-size: 36px;
            }
            
            .timer-buttons {
                flex-direction: column;
                align-items: center;
            }
            
            .timer-btn {
                width: 100%;
                max-width: 200px;
            }
            
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .nav-grid {
                grid-template-columns: repeat(auto-fit, minmax(110px, 1fr));
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>🏗️ KIEROWNIK PRO</h1>
            <p>System Zarządzania Projektami Budowlanymi</p>
        </div>
        
        <!-- MAIN NAVIGATION -->
        <input type="radio" name="main-nav" id="nav-dashboard" class="nav-input" checked>
        
        <div class="main-nav">
            <label for="nav-dashboard">🏠 DASHBOARD</label>
        </div>
        
        <!-- PROJECT NAVIGATION (dynamically generated) -->
        <div id="project-nav-container"></div>
        
        <!-- Content Sections -->
        <div class="content">
            <!-- DASHBOARD SECTION -->
            <div id="section-dashboard" class="section">
                <h2>🏠 Dashboard - Przegląd Projektów</h2>
                
                <!-- Projects Grid (dynamically generated) -->
                <div class="dashboard-grid" id="projects-grid">
                    <!-- Projects will be inserted here -->
                </div>
                
                <!-- Import projektu z edytora -->
                <div class="import-section">
                    <h4>📥 Import projektu z edytora</h4>
                    <div class="import-instructions">
                        <p><strong>Jak zaimportować projekt:</strong></p>
                        <ol style="margin-left: 20px; margin-top: 10px;">
                            <li><strong>Z edytora:</strong> Otwórz <a href="https://artur9871.github.io/kierownik-pro2/editor.html" target="_blank" style="color: #0369a1;">Edytor projektów</a>, wyeksportuj i skopiuj JSON</li>
                            <li><strong>Z CSV:</strong> Skopiuj dane CSV z projektu (z kolumnami: Projekt, Zadanie, Typ, itp.)</li>
                            <li>Wklej dane w polu poniżej i naciśnij odpowiedni przycisk</li>
                        </ol>
                    </div>
                    
                    <!-- Format selector -->
                    <div style="margin: 15px 0;">
                        <label style="display: block; margin-bottom: 5px; font-weight: 600;">Format danych:</label>
                        <div style="display: flex; gap: 10px;">
                            <label style="display: flex; align-items: center; cursor: pointer;">
                                <input type="radio" name="importFormat" value="json" checked style="margin-right: 5px;">
                                📄 JSON (z edytora)
                            </label>
                            <label style="display: flex; align-items: center; cursor: pointer;">
                                <input type="radio" name="importFormat" value="csv" style="margin-right: 5px;">
                                📊 CSV (dane tabelaryczne)
                            </label>
                        </div>
                    </div>
                    
                    <div style="display: flex; gap: 10px; align-items: end;">
                        <div style="flex: 1;">
                            <label style="display: block; margin-bottom: 5px; font-weight: 600;">Dane projektu:</label>
                            <textarea id="importProjectData" placeholder="Wklej tutaj dane JSON lub CSV..." style="height: 120px; font-family: monospace; font-size: 12px;"></textarea>
                        </div>
                        <div style="display: flex; flex-direction: column; gap: 5px;">
                            <button onclick="importProject()" class="btn btn-success">📥 Importuj JSON</button>
                            <button onclick="importCSVProject()" class="btn btn-warning">📊 Importuj CSV</button>
                        </div>
                    </div>
                    
                    <!-- CSV format help -->
                    <div id="csvHelp" style="background: #fff3cd; border: 1px solid #ffeaa7; padding: 10px; border-radius: 6px; margin-top: 10px; display: none;">
                        <p style="color: #856404; font-size: 12px; margin: 0;">
                            <strong>Format CSV:</strong> Projekt,Klient,Powierzchnia,Zadanie,Typ,Wydajność,Jednostka,Szacowany_czas
                        </p>
                    </div>
                </div>
                
                <!-- Szybkie akcje -->
                <div style="display: flex; gap: 10px; flex-wrap: wrap; margin-top: 20px;">
                    <button class="btn" onclick="manualBackup()">💾 Backup danych</button>
                    <button class="btn btn-secondary" onclick="restoreFromFile()">📥 Przywróć dane</button>
                    <button class="btn" onclick="exportAllData()">📊 Eksportuj raporty</button>
                    <button class="btn btn-warning" onclick="clearAllData()">🗑️ Wyczyść wszystko</button>
                    <a href="https://artur9871.github.io/kierownik-pro2/editor.html" target="_blank" class="btn btn-success">🔧 Otwórz edytor</a>
                </div>
                
                <!-- Storage info -->
                <div style="background: #f8fafc; padding: 15px; border-radius: 8px; margin-top: 20px; border: 1px solid #e2e8f0;">
                    <h4 style="color: #2d3748; margin-bottom: 10px;">📊 Informacje o danych</h4>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; font-size: 14px;">
                        <div>
                            <strong>Projektów:</strong> <span id="projectCount">0</span><br>
                            <strong>Historia zadań:</strong> <span id="taskHistoryCount">0</span>
                        </div>
                        <div>
                            <strong>Ostatni zapis:</strong> <span id="lastSaveTime">Brak</span><br>
                            <strong>Rozmiar danych:</strong> <span id="dataSize">0 KB</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- PROJECT SECTIONS (dynamically generated) -->
            <div id="project-sections-container"></div>
        </div>
    </div>

    <script>
        // Global state
        let projects = [];
        let currentProject = null;
        let currentTimer = {
            isRunning: false,
            isPaused: false,
            startTime: null,
            pausedTime: 0,
            currentTask: null,
            elapsedTime: 0
        };
        let timerInterval = null;
        let taskHistory = [];
        let appSettings = {
            autoBackup: true,
            backupInterval: 24,
            lastBackup: null
        };
        
        // Default projects
        const defaultProjects = [
            {
                id: 'project1',
                name: 'Dom Kowalski',
                location: 'ul. Kwiatowa 15, Poznań',
                icon: '🏠',
                status: 'active',
                statusText: '🟢 AKTYWNY',
                progress: 65,
                todayTask: 'Gruntowanie',
                surface: '120m²',
                contact: '+48601234567',
                mapUrl: 'https://maps.apple.com/?q=ul.+Kwiatowa+15+Poznań',
                gradient: 'linear-gradient(135deg, #4facfe 0%, #00f2fe 100%)',
                categories: {
                    'przygotowania': {
                        name: 'Przygotowania do prac',
                        tasks: ['Zabezpieczanie powierzchni', 'Przygotowanie sprzętu']
                    },
                    'przygotowanie-podloza': {
                        name: 'Przygotowanie Podłoża',
                        tasks: ['Szlifowanie powierzchni', 'Odkurzanie', 'Nacinanie i łatanie spękań', 'Oklejanie zabezpieczające']
                    },
                    'aplikacja-zywic': {
                        name: 'Aplikacja żywic',
                        tasks: ['Gruntowanie', 'Warstwa dodatkowa', 'Aplikacja warstwy wierzchniej', 'Aplikacja lakieru', 'Sprzątanie', 'Cokoły', 'Inne']
                    }
                }
            },
            {
                id: 'project2',
                name: 'Mieszkanie Nowak',
                location: 'ul. Różana 8, Poznań',
                icon: '🏢',
                status: 'planning',
                statusText: '🟡 PLANOWANIE',
                startDate: '28.06.2025',
                estimatedTime: '5 dni',
                surface: '85m²',
                contact: '+48602345678',
                mapUrl: 'https://maps.apple.com/?q=ul.+Różana+8+Poznań',
                gradient: 'linear-gradient(135deg, #f093fb 0%, #f5576c 100%)',
                categories: {
                    'przygotowania': {
                        name: 'Przygotowania do prac',
                        tasks: ['Zabezpieczanie powierzchni', 'Przygotowanie sprzętu']
                    },
                    'przygotowanie-podloza': {
                        name: 'Przygotowanie Podłoża',
                        tasks: ['Zrywanie niewłaściwego podłoża', 'Szlifowanie powierzchni', 'Odkurzanie', 'Nacinanie i łatanie spękań', 'Łatanie/równanie punktowe', 'Oklejanie zabezpieczające']
                    },
                    'aplikacja-zywic': {
                        name: 'Aplikacja żywic',
                        tasks: ['Gruntowanie', 'Warstwa dodatkowa', 'Aplikacja warstwy wierzchniej', 'Aplikacja lakieru', 'Sprzątanie', 'Cokoły', 'Inne']
                    }
                }
            }
        ];
        
        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            showLoadingIndicator();
            initializeApp();
        });
        
        async function initializeApp() {
            try {
                // Load data from storage
                await loadDataFromStorage();
                
                // Initialize UI
                updateCurrentDate();
                renderDashboard();
                
                // Setup auto-backup
                setupAutoBackup();
                
                // Add radio button listeners for import format
                document.querySelectorAll('input[name="importFormat"]').forEach(radio => {
                    radio.addEventListener('change', function() {
                        const csvHelp = document.getElementById('csvHelp');
                        if (this.value === 'csv') {
                            csvHelp.style.display = 'block';
                        } else {
                            csvHelp.style.display = 'none';
                        }
                    });
                });
                
                hideLoadingIndicator();
                showSaveNotification('✅ Dane załadowane pomyślnie', 'success');
                
            } catch (error) {
                console.error('Error initializing app:', error);
                hideLoadingIndicator();
                showSaveNotification('⚠️ Błąd ładowania danych - używam wartości domyślnych', 'warning');
                loadDefaultProjects();
                renderDashboard();
            }
        }
        
        // Storage functions
        function saveDataToStorage() {
            try {
                const data = {
                    version: '3.0',
                    lastSaved: new Date().toISOString(),
                    projects: projects,
                    taskHistory: taskHistory,
                    settings: appSettings,
                    currentTimer: {
                        ...currentTimer,
                        // Don't save intervals or functions
                        startTime: currentTimer.startTime,
                        isRunning: false // Reset running state on save
                    }
                };
                
                localStorage.setItem('kierownikPro_data', JSON.stringify(data));
                localStorage.setItem('kierownikPro_lastSave', Date.now().toString());
                
                // Visual feedback
                showSaveNotification('💾 Zapisano', 'success');
                
                return true;
            } catch (error) {
                console.error('Error saving data:', error);
                showSaveNotification('❌ Błąd zapisu', 'error');
                return false;
            }
        }
        
        async function loadDataFromStorage() {
            try {
                const savedData = localStorage.getItem('kierownikPro_data');
                
                if (!savedData) {
                    // No saved data - load defaults
                    loadDefaultProjects();
                    return;
                }
                
                const data = JSON.parse(savedData);
                
                // Validate data structure
                if (!data.version || !data.projects) {
                    throw new Error('Invalid data structure');
                }
                
                // Load data
                projects = data.projects || [];
                taskHistory = data.taskHistory || [];
                appSettings = { ...appSettings, ...data.settings };
                
                // Ensure we have some projects
                if (projects.length === 0) {
                    loadDefaultProjects();
                }
                
                // Update last save time
                if (data.lastSaved) {
                    const lastSave = new Date(data.lastSaved);
                    console.log('Data loaded from:', lastSave.toLocaleString('pl-PL'));
                }
                
                return true;
            } catch (error) {
                console.error('Error loading data:', error);
                loadDefaultProjects();
                throw error;
            }
        }
        
        function loadDefaultProjects() {
            projects = [...defaultProjects];
            taskHistory = [];
            appSettings = {
                autoBackup: true,
                backupInterval: 24,
                lastBackup: null
            };
        }
        
        // Auto-save after every significant action
        function autoSave() {
            if (appSettings.autoBackup) {
                saveDataToStorage();
            }
        }
        
        // Setup automatic backup
        function setupAutoBackup() {
            if (!appSettings.autoBackup) return;
            
            const interval = appSettings.backupInterval * 60 * 60 * 1000; // hours to ms
            
            setInterval(() => {
                const now = Date.now();
                const lastBackup = appSettings.lastBackup || 0;
                
                if (now - lastBackup > interval) {
                    createAutoBackup();
                    appSettings.lastBackup = now;
                    autoSave();
                }
            }, 60000); // Check every minute
        }
        
        function createAutoBackup() {
            try {
                const backupData = {
                    timestamp: new Date().toISOString(),
                    projects: projects,
                    taskHistory: taskHistory,
                    settings: appSettings
                };
                
                const backupKey = `kierownikPro_backup_${Date.now()}`;
                localStorage.setItem(backupKey, JSON.stringify(backupData));
                
                // Keep only last 5 backups
                cleanOldBackups();
                
                showSaveNotification('🔄 Backup automatyczny utworzony', 'info');
            } catch (error) {
                console.error('Auto backup failed:', error);
            }
        }
        
        function cleanOldBackups() {
            const keys = Object.keys(localStorage).filter(key => key.startsWith('kierownikPro_backup_'));
            
            if (keys.length > 5) {
                // Sort by timestamp and remove oldest
                keys.sort();
                for (let i = 0; i < keys.length - 5; i++) {
                    localStorage.removeItem(keys[i]);
                }
            }
        }
        
        // Visual feedback functions
        function showLoadingIndicator() {
            const indicator = document.createElement('div');
            indicator.id = 'loadingIndicator';
            indicator.innerHTML = `
                <div style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(102, 126, 234, 0.9); display: flex; align-items: center; justify-content: center; z-index: 9999;">
                    <div style="background: white; padding: 30px; border-radius: 15px; text-align: center; box-shadow: 0 10px 30px rgba(0,0,0,0.3);">
                        <div style="font-size: 24px; margin-bottom: 15px;">🏗️</div>
                        <div style="font-size: 18px; font-weight: 600; color: #2d3748; margin-bottom: 10px;">KIEROWNIK PRO</div>
                        <div style="font-size: 14px; color: #718096;">Ładowanie danych...</div>
                    </div>
                </div>
            `;
            document.body.appendChild(indicator);
        }
        
        function hideLoadingIndicator() {
            const indicator = document.getElementById('loadingIndicator');
            if (indicator) {
                indicator.remove();
            }
        }
        
        function showSaveNotification(message, type = 'success') {
            // Remove existing notification
            const existing = document.getElementById('saveNotification');
            if (existing) existing.remove();
            
            const colors = {
                success: '#16a34a',
                error: '#dc2626',
                warning: '#d97706',
                info: '#3b82f6'
            };
            
            const notification = document.createElement('div');
            notification.id = 'saveNotification';
            notification.innerHTML = message;
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: ${colors[type]};
                color: white;
                padding: 12px 20px;
                border-radius: 8px;
                font-size: 14px;
                font-weight: 600;
                box-shadow: 0 4px 15px rgba(0,0,0,0.2);
                z-index: 1000;
                animation: slideIn 0.3s ease;
            `;
            
            // Add animation
            const style = document.createElement('style');
            style.textContent = `
                @keyframes slideIn {
                    from { transform: translateX(100%); opacity: 0; }
                    to { transform: translateX(0); opacity: 1; }
                }
            `;
            document.head.appendChild(style);
            
            document.body.appendChild(notification);
            
            // Auto-remove after 3 seconds
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.style.animation = 'slideIn 0.3s ease reverse';
                    setTimeout(() => notification.remove(), 300);
                }
            }, 3000);
        }
        
        function renderDashboard() {
            const grid = document.getElementById('projects-grid');
            grid.innerHTML = '';
            
            projects.forEach(project => {
                const card = createProjectCard(project);
                grid.appendChild(card);
            });
            
            // Create navigation for all projects
            createProjectNavigation();
            
            // Update storage info
            updateStorageInfo();
        }
        
        function updateStorageInfo() {
            const elements = {
                projectCount: document.getElementById('projectCount'),
                taskHistoryCount: document.getElementById('taskHistoryCount'),
                lastSaveTime: document.getElementById('lastSaveTime'),
                dataSize: document.getElementById('dataSize')
            };
            
            if (elements.projectCount) elements.projectCount.textContent = projects.length;
            if (elements.taskHistoryCount) elements.taskHistoryCount.textContent = taskHistory.length;
            
            if (elements.lastSaveTime) {
                const lastSave = localStorage.getItem('kierownikPro_lastSave');
                if (lastSave) {
                    const date = new Date(parseInt(lastSave));
                    elements.lastSaveTime.textContent = date.toLocaleString('pl-PL');
                } else {
                    elements.lastSaveTime.textContent = 'Brak';
                }
            }
            
            if (elements.dataSize) {
                const data = localStorage.getItem('kierownikPro_data');
                if (data) {
                    const sizeKB = Math.round(new Blob([data]).size / 1024);
                    elements.dataSize.textContent = sizeKB + ' KB';
                } else {
                    elements.dataSize.textContent = '0 KB';
                }
            }
        }
        
        function createProjectCard(project) {
            const card = document.createElement('div');
            card.className = 'project-card' + (project.imported ? ' imported' : '');
            card.style.background = project.gradient;
            card.onclick = () => selectProject(project.id);
            
            const statusClass = project.status === 'active' ? 'status-active' : 
                               project.status === 'planning' ? 'status-planning' : 'status-imported';
            
            let infoContent = '';
            if (project.status === 'active') {
                infoContent = `
                    <div class="info-item">
                        <span class="info-label">Postęp ogólny</span>
                        <span class="info-value">${project.progress}%</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Dziś zaplanowano</span>
                        <span class="info-value">${project.todayTask}</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Czas dziś</span>
                        <span class="info-value project-time" data-project="${project.id}">0h 0m</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Status BHP</span>
                        <span class="info-value">✅ OK</span>
                    </div>
                `;
            } else if (project.status === 'planning') {
                infoContent = `
                    <div class="info-item">
                        <span class="info-label">Start prac</span>
                        <span class="info-value">${project.startDate}</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Szac. czas</span>
                        <span class="info-value">${project.estimatedTime}</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Powierzchnia</span>
                        <span class="info-value">${project.surface}</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Status</span>
                        <span class="info-value">Czeka na materiały</span>
                    </div>
                `;
            } else {
                infoContent = `
                    <div class="info-item">
                        <span class="info-label">Zadań</span>
                        <span class="info-value">${project.taskCount || 0}</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Powierzchnia</span>
                        <span class="info-value">${project.surface}</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Klient</span>
                        <span class="info-value">${project.client || 'Brak'}</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Status</span>
                        <span class="info-value">Gotowy do pracy</span>
                    </div>
                `;
            }
            
            card.innerHTML = `
                <h3>${project.icon} ${project.name}</h3>
                <div class="project-status ${statusClass}">${project.statusText}</div>
                
                <div class="project-info">
                    ${infoContent}
                </div>
                
                <div class="quick-actions">
                    <a href="tel:${project.contact}" class="quick-action">📞 ${project.contactName || 'Kontakt'}</a>
                    ${project.mapUrl ? `<a href="${project.mapUrl}" class="quick-action">🗺️ Nawigacja</a>` : ''}
                    <span class="quick-action">⏰ Timer</span>
                </div>
            `;
            
            return card;
        }
        
        function createProjectNavigation() {
            const container = document.getElementById('project-nav-container');
            const sectionsContainer = document.getElementById('project-sections-container');
            
            container.innerHTML = '';
            sectionsContainer.innerHTML = '';
            
            projects.forEach((project, index) => {
                // Create navigation inputs
                const navInput = document.createElement('input');
                navInput.type = 'radio';
                navInput.name = 'main-nav';
                navInput.id = `nav-${project.id}`;
                navInput.className = 'nav-input';
                container.appendChild(navInput);
                
                // Create project navigation
                const projectNav = document.createElement('div');
                projectNav.className = 'project-nav';
                projectNav.id = `${project.id}-nav`;
                
                const navGrid = document.createElement('div');
                navGrid.className = 'nav-grid';
                
                navGrid.innerHTML = `
                    <button class="back-btn" onclick="backToDashboard()">← Dashboard</button>
                    <button onclick="selectProjectSection('${project.id}', 'czas')">⏰ Czas</button>
                    <button onclick="selectProjectSection('${project.id}', 'kalendarz')">📅 Kalendarz</button>
                    <button onclick="selectProjectSection('${project.id}', 'materialy')">🎨 Materiały</button>
                    <button onclick="selectProjectSection('${project.id}', 'sprzet')">🔧 Sprzęt</button>
                    <button onclick="selectProjectSection('${project.id}', 'bhp')">⛑️ BHP</button>
                    <button onclick="selectProjectSection('${project.id}', 'logistyka')">🚚 Logistyka</button>
                `;
                
                projectNav.appendChild(navGrid);
                container.appendChild(projectNav);
                
                // Create project sections
                createProjectSections(project, sectionsContainer);
                
                // Add navigation style updates
                navInput.addEventListener('change', function() {
                    if (this.checked) {
                        // Hide all project navs
                        document.querySelectorAll('.project-nav').forEach(nav => nav.style.display = 'none');
                        // Show this project nav
                        document.getElementById(`${project.id}-nav`).style.display = 'block';
                        // Set current project
                        currentProject = project;
                    }
                });
            });
        }
        
        function createProjectSections(project, container) {
            // Default section
            const defaultSection = document.createElement('div');
            defaultSection.className = 'section project-section';
            defaultSection.id = `section-${project.id}-default`;
            defaultSection.innerHTML = `
                <h2>${project.icon} ${project.name} - Wybierz sekcję</h2>
                <p style="margin-bottom: 20px; color: #718096;">Kliknij na sekcję aby zobaczyć szczegóły projektu.</p>
                
                <div class="section-tiles">
                    <div class="section-tile" onclick="selectProjectSection('${project.id}', 'czas')">
                        <div style="font-size: 24px; margin-bottom: 10px;">⏰</div>
                        <h4>Czas pracy</h4>
                        <p style="font-size: 12px; color: #718096;">Timer, działania, historia</p>
                    </div>
                    <div class="section-tile" onclick="selectProjectSection('${project.id}', 'kalendarz')">
                        <div style="font-size: 24px; margin-bottom: 10px;">📅</div>
                        <h4>Kalendarz</h4>
                        <p style="font-size: 12px; color: #718096;">Harmonogram, zmiany</p>
                    </div>
                    <div class="section-tile" onclick="selectProjectSection('${project.id}', 'materialy')">
                        <div style="font-size: 24px; margin-bottom: 10px;">🎨</div>
                        <h4>Materiały</h4>
                        <p style="font-size: 12px; color: #718096;">System, proporcje, zużycie</p>
                    </div>
                    <div class="section-tile" onclick="selectProjectSection('${project.id}', 'sprzet')">
                        <div style="font-size: 24px; margin-bottom: 10px;">🔧</div>
                        <h4>Sprzęt</h4>
                        <p style="font-size: 12px; color: #718096;">Checklist, tracking</p>
                    </div>
                    <div class="section-tile" onclick="selectProjectSection('${project.id}', 'bhp')">
                        <div style="font-size: 24px; margin-bottom: 10px;">⛑️</div>
                        <h4>BHP</h4>
                        <p style="font-size: 12px; color: #718096;">Bezpieczeństwo, środki ochrony</p>
                    </div>
                    <div class="section-tile" onclick="selectProjectSection('${project.id}', 'logistyka')">
                        <div style="font-size: 24px; margin-bottom: 10px;">🚚</div>
                        <h4>Logistyka</h4>
                        <p style="font-size: 12px; color: #718096;">Dostęp, prąd, składowanie</p>
                    </div>
                </div>
            `;
            container.appendChild(defaultSection);
            
            // Timer section
            const timerSection = document.createElement('div');
            timerSection.className = 'section project-section';
            timerSection.id = `section-${project.id}-czas`;
            timerSection.innerHTML = createTimerSection(project);
            container.appendChild(timerSection);
            
            // Other sections (placeholder)
            const sections = ['kalendarz', 'materialy', 'sprzet', 'bhp', 'logistyka'];
            sections.forEach(sectionName => {
                const section = document.createElement('div');
                section.className = 'section project-section';
                section.id = `section-${project.id}-${sectionName}`;
                section.innerHTML = `
                    <h2>${getSectionIcon(sectionName)} ${getSectionName(sectionName)} - ${project.name}</h2>
                    <p>Funkcjonalność ${getSectionName(sectionName).toLowerCase()} będzie dodana w kolejnych wersjach.</p>
                `;
                container.appendChild(section);
            });
        }
        
        function createTimerSection(project) {
            return `
                <h2>⏰ Timer Pracy - ${project.name}</h2>
                
                <div class="timer-container">
                    <!-- Selektor projektów/zadań -->
                    <div class="project-selector">
                        <h3>🎯 Wybierz zadanie do wykonania</h3>
                        
                        <div class="form-group">
                            <label>📋 Kategoria:</label>
                            <select id="taskCategory-${project.id}" onchange="updateProjectTasks('${project.id}')">
                                <option value="">-- Wybierz kategorię --</option>
                                ${Object.entries(project.categories || {}).map(([key, category]) => 
                                    `<option value="${key}">${category.name}</option>`
                                ).join('')}
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label>⏰ Zadanie:</label>
                            <select id="taskSelect-${project.id}" onchange="selectProjectTask('${project.id}')" disabled>
                                <option value="">-- Najpierw wybierz kategorię --</option>
                            </select>
                        </div>
                    </div>
                    
                    <!-- Timer display -->
                    <div class="timer-display">
                        <div class="timer-status" id="timerStatus-${project.id}">Gotowy do rozpoczęcia</div>
                        <div id="currentTask-${project.id}" style="font-size: 20px; margin-bottom: 10px;">Wybierz zadanie aby rozpocząć</div>
                        <div class="timer-time" id="timerDisplay-${project.id}">00:00:00</div>
                        <div class="timer-buttons">
                            <button id="startBtn-${project.id}" class="timer-btn" onclick="startTimer('${project.id}')" disabled>▶️ Start</button>
                            <button id="pauseBtn-${project.id}" class="timer-btn" onclick="pauseTimer('${project.id}')" disabled>⏸️ Pauza</button>
                            <button id="stopBtn-${project.id}" class="timer-btn" onclick="stopTimer('${project.id}')" disabled>✅ Zakończ</button>
                        </div>
                    </div>
                    
                    <!-- Statystyki dnia -->
                    <div class="task-history">
                        <h3>📊 Podsumowanie dziś - <span id="currentDate-${project.id}"></span></h3>
                        <div class="stats-grid">
                            <div class="stat-item">
                                <div class="stat-value" id="totalTime-${project.id}">0:00</div>
                                <div class="stat-label">Łączny czas</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-value" id="completedTasks-${project.id}">0</div>
                                <div class="stat-label">Ukończone</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-value" id="activeTasks-${project.id}">0</div>
                                <div class="stat-label">W trakcie</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-value" id="avgTime-${project.id}">0:00</div>
                                <div class="stat-label">Średnia/zadanie</div>
                            </div>
                        </div>
                        
                        <div style="display: flex; gap: 10px; margin: 20px 0;">
                            <button class="btn" onclick="exportProjectData('${project.id}')">📊 Eksport CSV</button>
                            <button class="btn btn-secondary" onclick="exportDetailedProjectData('${project.id}')">📋 Eksport szczegółowy</button>
                            <button class="btn btn-warning" onclick="clearProjectHistory('${project.id}')">🗑️ Wyczyść historię</button>
                        </div>
                        
                        <h4 style="margin-top: 30px; margin-bottom: 15px;">📋 Historia działań</h4>
                        <div id="historyList-${project.id}">
                            <p style="color: #718096; text-align: center; padding: 20px;">Brak zarejestrowanych działań</p>
                        </div>
                    </div>
                </div>
            `;
        }
        
        function getSectionIcon(sectionName) {
            const icons = {
                'kalendarz': '📅',
                'materialy': '🎨',
                'sprzet': '🔧',
                'bhp': '⛑️',
                'logistyka': '🚚'
            };
            return icons[sectionName] || '📋';
        }
        
        function getSectionName(sectionName) {
            const names = {
                'kalendarz': 'Kalendarz',
                'materialy': 'Materiały',
                'sprzet': 'Sprzęt',
                'bhp': 'BHP',
                'logistyka': 'Logistyka'
            };
            return names[sectionName] || sectionName;
        }
        
        function selectProject(projectId) {
            // Hide dashboard
            document.getElementById('nav-dashboard').checked = false;
            
            // Select project
            document.getElementById(`nav-${projectId}`).checked = true;
            
            // Show project navigation
            document.querySelectorAll('.project-nav').forEach(nav => nav.style.display = 'none');
            document.getElementById(`${projectId}-nav`).style.display = 'block';
            
            // Show default project section
            document.querySelectorAll('.section').forEach(section => section.style.display = 'none');
            document.getElementById(`section-${projectId}-default`).style.display = 'block';
            
            // Set current project
            currentProject = projects.find(p => p.id === projectId);
            
            // Update timer for this project
            updateCurrentDate(projectId);
            updateProjectStats(projectId);
            updateProjectHistoryDisplay(projectId);
        }
        
        function selectProjectSection(projectId, sectionName) {
            // Hide all sections
            document.querySelectorAll('.section').forEach(section => section.style.display = 'none');
            
            // Show selected section
            document.getElementById(`section-${projectId}-${sectionName}`).style.display = 'block';
            
            if (sectionName === 'czas') {
                updateCurrentDate(projectId);
                updateProjectStats(projectId);
                updateProjectHistoryDisplay(projectId);
            }
        }
        
        function backToDashboard() {
            // Hide all project navs and sections
            document.querySelectorAll('.project-nav').forEach(nav => nav.style.display = 'none');
            document.querySelectorAll('.section').forEach(section => section.style.display = 'none');
            
            // Show dashboard
            document.getElementById('nav-dashboard').checked = true;
            document.getElementById('section-dashboard').style.display = 'block';
            
            currentProject = null;
        }
        
        function updateProjectTasks(projectId) {
            const project = projects.find(p => p.id === projectId);
            const category = document.getElementById(`taskCategory-${projectId}`).value;
            const taskSelect = document.getElementById(`taskSelect-${projectId}`);
            
            taskSelect.innerHTML = '<option value="">-- Wybierz zadanie --</option>';
            
            if (category && project.categories && project.categories[category]) {
                taskSelect.disabled = false;
                project.categories[category].tasks.forEach(task => {
                    const option = document.createElement('option');
                    option.value = task;
                    option.textContent = task;
                    taskSelect.appendChild(option);
                });
            } else {
                taskSelect.disabled = true;
                taskSelect.innerHTML = '<option value="">-- Najpierw wybierz kategorię --</option>';
            }
        }
        
        function selectProjectTask(projectId) {
            const task = document.getElementById(`taskSelect-${projectId}`).value;
            const startBtn = document.getElementById(`startBtn-${projectId}`);
            
            if (task) {
                currentTimer.currentTask = task;
                currentTimer.projectId = projectId;
                document.getElementById(`currentTask-${projectId}`).textContent = task;
                startBtn.disabled = false;
                document.getElementById(`timerStatus-${projectId}`).textContent = 'Gotowy do rozpoczęcia';
            } else {
                currentTimer.currentTask = null;
                currentTimer.projectId = null;
                document.getElementById(`currentTask-${projectId}`).textContent = 'Wybierz zadanie aby rozpocząć';
                startBtn.disabled = true;
                document.getElementById(`timerStatus-${projectId}`).textContent = 'Wybierz zadanie';
            }
        }
        
        function startTimer(projectId) {
            if (!currentTimer.currentTask || currentTimer.projectId !== projectId) return;
            
            if (currentTimer.isPaused) {
                // Resume from pause
                currentTimer.startTime = Date.now() - currentTimer.pausedTime;
                currentTimer.isPaused = false;
            } else {
                // New start
                currentTimer.startTime = Date.now();
                currentTimer.pausedTime = 0;
            }
            
            currentTimer.isRunning = true;
            document.getElementById(`timerStatus-${projectId}`).textContent = 'W trakcie realizacji';
            
            // Update button states
            document.getElementById(`startBtn-${projectId}`).disabled = true;
            document.getElementById(`pauseBtn-${projectId}`).disabled = false;
            document.getElementById(`stopBtn-${projectId}`).disabled = false;
            
            // Start the interval
            timerInterval = setInterval(() => updateTimerDisplay(projectId), 1000);
        }
        
        function pauseTimer(projectId) {
            if (!currentTimer.isRunning || currentTimer.projectId !== projectId) return;
            
            currentTimer.isRunning = false;
            currentTimer.isPaused = true;
            currentTimer.pausedTime = Date.now() - currentTimer.startTime;
            
            clearInterval(timerInterval);
            
            document.getElementById(`timerStatus-${projectId}`).textContent = 'Wstrzymany';
            
            // Update button states
            document.getElementById(`startBtn-${projectId}`).disabled = false;
            document.getElementById(`pauseBtn-${projectId}`).disabled = true;
            document.getElementById(`stopBtn-${projectId}`).disabled = false;
        }
        
        function stopTimer(projectId) {
            if (!currentTimer.currentTask || currentTimer.projectId !== projectId) return;
            
            // Calculate final time
            let finalTime;
            if (currentTimer.isRunning) {
                finalTime = Date.now() - currentTimer.startTime;
            } else if (currentTimer.isPaused) {
                finalTime = currentTimer.pausedTime;
            } else {
                return;
            }
            
            // Add to history
            const taskRecord = {
                task: currentTimer.currentTask,
                projectId: projectId,
                projectName: projects.find(p => p.id === projectId)?.name || 'Unknown',
                category: document.getElementById(`taskCategory-${projectId}`).value,
                startTime: new Date(currentTimer.startTime),
                duration: finalTime,
                date: new Date().toDateString()
            };
            
            taskHistory.push(taskRecord);
            
            // Auto-save after adding task
            autoSave();
            
            // Reset timer
            resetTimer(projectId);
            
            // Update displays
            updateProjectStats(projectId);
            updateProjectHistoryDisplay(projectId);
            updateDashboard();
        }
        
        function resetTimer(projectId) {
            currentTimer.isRunning = false;
            currentTimer.isPaused = false;
            currentTimer.startTime = null;
            currentTimer.pausedTime = 0;
            currentTimer.elapsedTime = 0;
            currentTimer.projectId = null;
            
            clearInterval(timerInterval);
            
            document.getElementById(`timerDisplay-${projectId}`).textContent = '00:00:00';
            document.getElementById(`timerStatus-${projectId}`).textContent = 'Zakończone';
            
            // Reset button states
            document.getElementById(`startBtn-${projectId}`).disabled = false;
            document.getElementById(`pauseBtn-${projectId}`).disabled = true;
            document.getElementById(`stopBtn-${projectId}`).disabled = true;
            
            setTimeout(() => {
                if (currentTimer.currentTask) {
                    document.getElementById(`timerStatus-${projectId}`).textContent = 'Gotowy do rozpoczęcia';
                }
            }, 2000);
        }
        
        function updateTimerDisplay(projectId) {
            if (!currentTimer.isRunning || !currentTimer.startTime || currentTimer.projectId !== projectId) return;
            
            const elapsed = Date.now() - currentTimer.startTime;
            document.getElementById(`timerDisplay-${projectId}`).textContent = formatTime(elapsed);
        }
        
        function updateCurrentDate(projectId) {
            const now = new Date();
            const options = { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            };
            
            if (projectId) {
                const element = document.getElementById(`currentDate-${projectId}`);
                if (element) {
                    element.textContent = now.toLocaleDateString('pl-PL', options);
                }
            } else {
                // Update all project dates
                projects.forEach(project => {
                    const element = document.getElementById(`currentDate-${project.id}`);
                    if (element) {
                        element.textContent = now.toLocaleDateString('pl-PL', options);
                    }
                });
            }
        }
        
        function updateProjectStats(projectId) {
            const today = new Date().toDateString();
            const projectTasks = taskHistory.filter(task => task.date === today && task.projectId === projectId);
            
            const totalTime = projectTasks.reduce((sum, task) => sum + task.duration, 0);
            const completedTasks = projectTasks.length;
            const activeTasks = (currentTimer.isRunning && currentTimer.projectId === projectId) ? 1 : 0;
            const avgTime = completedTasks > 0 ? totalTime / completedTasks : 0;
            
            const elements = {
                totalTime: document.getElementById(`totalTime-${projectId}`),
                completedTasks: document.getElementById(`completedTasks-${projectId}`),
                activeTasks: document.getElementById(`activeTasks-${projectId}`),
                avgTime: document.getElementById(`avgTime-${projectId}`)
            };
            
            if (elements.totalTime) elements.totalTime.textContent = formatDuration(totalTime);
            if (elements.completedTasks) elements.completedTasks.textContent = completedTasks;
            if (elements.activeTasks) elements.activeTasks.textContent = activeTasks;
            if (elements.avgTime) elements.avgTime.textContent = formatDuration(avgTime);
        }
        
        function updateProjectHistoryDisplay(projectId) {
            const historyList = document.getElementById(`historyList-${projectId}`);
            if (!historyList) return;
            
            const today = new Date().toDateString();
            const projectTasks = taskHistory.filter(task => task.date === today && task.projectId === projectId).reverse();
            
            if (projectTasks.length === 0) {
                historyList.innerHTML = '<p style="color: #718096; text-align: center; padding: 20px;">Brak zarejestrowanych działań</p>';
                return;
            }
            
            historyList.innerHTML = projectTasks.map(task => `
                <div class="history-item">
                    <div class="task-info">
                        <div class="task-name">${task.task}</div>
                        <div class="task-details">
                            ${task.startTime.toLocaleTimeString('pl-PL', {hour: '2-digit', minute: '2-digit'})} - 
                            ${task.category || 'Brak kategorii'}
                        </div>
                    </div>
                    <div class="task-duration">${formatDuration(task.duration)}</div>
                </div>
            `).join('');
        }
        
        function updateDashboard() {
            const today = new Date().toDateString();
            
            projects.forEach(project => {
                const projectTasks = taskHistory.filter(task => task.date === today && task.projectId === project.id);
                const totalTime = projectTasks.reduce((sum, task) => sum + task.duration, 0);
                
                const timeElement = document.querySelector(`.project-time[data-project="${project.id}"]`);
                if (timeElement) {
                    timeElement.textContent = formatDuration(totalTime);
                }
            });
        }
        
        function formatTime(milliseconds) {
            const seconds = Math.floor(milliseconds / 1000);
            const hours = Math.floor(seconds / 3600);
            const minutes = Math.floor((seconds % 3600) / 60);
            const secs = seconds % 60;
            
            return `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
        }
        
        function formatDuration(milliseconds) {
            const totalMinutes = Math.floor(milliseconds / (1000 * 60));
            const hours = Math.floor(totalMinutes / 60);
            const minutes = totalMinutes % 60;
            
            if (hours > 0) {
                return `${hours}h ${minutes}m`;
            }
            return `${minutes}m`;
        }
        
        function saveHistory() {
            // Note: Using in-memory storage only - data will not persist across sessions
            // This is due to Claude.ai artifact limitations
        }
        
        function loadHistory() {
            // Note: Using in-memory storage only - data will not persist across sessions
            // In a real implementation, this would load from localStorage
        }
        
        function exportProjectData(projectId) {
            const today = new Date().toDateString();
            const projectTasks = taskHistory.filter(task => task.date === today && task.projectId === projectId);
            const project = projects.find(p => p.id === projectId);
            
            let csv = 'Zadanie,Kategoria,Czas rozpoczęcia,Czas trwania (min),Data,Projekt\n';
            
            projectTasks.forEach(task => {
                const duration = Math.round(task.duration / (1000 * 60));
                csv += `"${task.task}","${task.category}","${task.startTime.toLocaleTimeString('pl-PL')}",${duration},"${task.date}","${task.projectName}"\n`;
            });
            
            downloadCSV(csv, `${project?.name || 'project'}-data-${new Date().toISOString().split('T')[0]}.csv`);
        }
        
        function exportDetailedProjectData(projectId) {
            const projectTasks = taskHistory.filter(task => task.projectId === projectId);
            const project = projects.find(p => p.id === projectId);
            
            let csv = 'Zadanie,Kategoria,Czas rozpoczęcia,Czas zakończenia,Czas trwania (min),Data,Projekt\n';
            
            projectTasks.forEach(task => {
                const duration = Math.round(task.duration / (1000 * 60));
                const endTime = new Date(task.startTime.getTime() + task.duration);
                csv += `"${task.task}","${task.category}","${task.startTime.toLocaleTimeString('pl-PL')}","${endTime.toLocaleTimeString('pl-PL')}",${duration},"${task.date}","${task.projectName}"\n`;
            });
            
            downloadCSV(csv, `${project?.name || 'project'}-detailed-${new Date().toISOString().split('T')[0]}.csv`);
        }
        
        function clearProjectHistory(projectId) {
            if (confirm('Czy na pewno chcesz wyczyścić historię zadań tego projektu?')) {
                taskHistory = taskHistory.filter(task => task.projectId !== projectId);
                
                // Auto-save after clearing history
                autoSave();
                
                updateProjectStats(projectId);
                updateProjectHistoryDisplay(projectId);
                updateDashboard();
                
                showSaveNotification('🗑️ Historia projektu wyczyszczona', 'warning');
            }
        }
        
        function manualBackup() {
            try {
                const backupData = {
                    version: '3.0',
                    timestamp: new Date().toISOString(),
                    projects: projects,
                    taskHistory: taskHistory,
                    settings: appSettings,
                    exportType: 'manual_backup'
                };
                
                const filename = `kierownik-pro-backup-${new Date().toISOString().split('T')[0]}.json`;
                downloadJSON(backupData, filename);
                
                showSaveNotification('💾 Backup pobrany pomyślnie', 'success');
            } catch (error) {
                console.error('Manual backup failed:', error);
                showSaveNotification('❌ Błąd tworzenia backup', 'error');
            }
        }
        
        function restoreFromFile() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            
            input.onchange = function(event) {
                const file = event.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const data = JSON.parse(e.target.result);
                        
                        // Validate backup data
                        if (!data.version || !data.projects || !data.taskHistory) {
                            throw new Error('Nieprawidłowy format pliku backup');
                        }
                        
                        // Confirm restore
                        if (!confirm('Czy na pewno chcesz przywrócić dane z pliku? Obecne dane zostaną zastąpione.')) {
                            return;
                        }
                        
                        // Restore data
                        projects = data.projects;
                        taskHistory = data.taskHistory;
                        appSettings = { ...appSettings, ...data.settings };
                        
                        // Save to storage
                        saveDataToStorage();
                        
                        // Re-render dashboard
                        renderDashboard();
                        
                        showSaveNotification('✅ Dane przywrócone pomyślnie', 'success');
                        
                    } catch (error) {
                        console.error('Restore failed:', error);
                        showSaveNotification('❌ Błąd przywracania danych', 'error');
                    }
                };
                reader.readAsText(file);
            };
            
            input.click();
        }
        
        function downloadJSON(data, filename) {
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', filename);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
        
        function exportAllData() {
            try {
                // Export report data (not backup - different format)
                const reportData = {
                    exportDate: new Date().toISOString(),
                    projectsSummary: projects.map(p => ({
                        name: p.name,
                        status: p.status,
                        taskCount: p.taskCount || 0,
                        surface: p.surface
                    })),
                    taskHistorySummary: {
                        totalTasks: taskHistory.length,
                        totalTime: taskHistory.reduce((sum, task) => sum + task.duration, 0),
                        byProject: projects.map(project => {
                            const projectTasks = taskHistory.filter(task => task.projectId === project.id);
                            return {
                                projectName: project.name,
                                tasksCount: projectTasks.length,
                                totalTime: projectTasks.reduce((sum, task) => sum + task.duration, 0)
                            };
                        })
                    },
                    version: '3.0'
                };
                
                const filename = `kierownik-pro-raport-${new Date().toISOString().split('T')[0]}.json`;
                downloadJSON(reportData, filename);
                
                showSaveNotification('📊 Raport wyeksportowany', 'success');
            } catch (error) {
                console.error('Export failed:', error);
                showSaveNotification('❌ Błąd eksportu', 'error');
            }
        }
        
        function clearAllData() {
            if (confirm('Czy na pewno chcesz wyczyścić wszystkie dane? Ta operacja jest nieodwracalna.\n\nDane zostaną zastąpione projektami domyślnymi.')) {
                taskHistory = [];
                loadDefaultProjects();
                
                // Save to storage
                autoSave();
                
                // Re-render
                renderDashboard();
                
                showSaveNotification('🗑️ Wszystkie dane wyczyszczone', 'warning');
            }
        }
        
        function downloadCSV(csv, filename) {
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', filename);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
        
        // Import functions
        function importProject() {
            const projectData = document.getElementById('importProjectData').value.trim();
            
            if (!projectData) {
                alert('Proszę wkleić kod JSON projektu.');
                return;
            }
            
            try {
                const project = JSON.parse(projectData);
                
                // Validate project structure
                if (!project.name || !project.tasks) {
                    throw new Error('Nieprawidłowa struktura projektu');
                }
                
                addImportedProject(project, 'json');
                document.getElementById('importProjectData').value = '';
                
            } catch (error) {
                alert('Błąd podczas importowania projektu. Sprawdź czy kod JSON jest prawidłowy.');
                console.error('Import error:', error);
            }
        }
        
        function importCSVProject() {
            const csvData = document.getElementById('importProjectData').value.trim();
            
            if (!csvData) {
                alert('Proszę wkleić dane CSV projektu.');
                return;
            }
            
            try {
                // Parse CSV data
                const lines = csvData.split('\n').filter(line => line.trim());
                if (lines.length < 2) {
                    throw new Error('CSV musi zawierać nagłówek i przynajmniej jeden wiersz danych');
                }
                
                // Parse header
                const header = lines[0].split(',').map(col => col.trim().replace(/"/g, ''));
                
                // Parse data rows
                const tasks = [];
                let projectName = '';
                let clientName = '';
                let surface = '';
                
                for (let i = 1; i < lines.length; i++) {
                    const values = parseCSVLine(lines[i]);
                    if (values.length < 4) continue;
                    
                    const row = {};
                    header.forEach((col, index) => {
                        if (values[index]) {
                            row[col] = values[index].replace(/"/g, '').trim();
                        }
                    });
                    
                    // Get project info from first row
                    if (i === 1) {
                        projectName = row['Projekt'] || 'Projekt zaimportowany';
                        clientName = row['Klient'] || '';
                        surface = row['Powierzchnia'] || '';
                    }
                    
                    // Create task object
                    const task = {
                        name: row['Zadanie'] || `Zadanie ${i}`,
                        type: row['Typ'] || 'fixed',
                        estimatedTime: parseFloat(row['Szacowany czas (h)']) || 1,
                        efficiency: row['Wydajność'] || '',
                        unit: row['Jednostka'] || 'h',
                        category: determineCategory(row['Zadanie'] || '')
                    };
                    
                    tasks.push(task);
                }
                
                if (tasks.length === 0) {
                    throw new Error('Nie znaleziono zadań w danych CSV');
                }
                
                // Create project object
                const project = {
                    name: projectName,
                    client: clientName,
                    surface: surface + 'm²',
                    tasks: tasks,
                    importedFrom: 'csv',
                    importDate: new Date().toISOString()
                };
                
                addImportedProject(project, 'csv');
                document.getElementById('importProjectData').value = '';
                
            } catch (error) {
                alert(`❌ Błąd podczas importowania CSV:\n\n${error.message}\n\nSprawdź format danych i spróbuj ponownie.`);
                console.error('CSV Import error:', error);
            }
        }
        
        function addImportedProject(projectData, importType) {
            // Create new project object
            const newProject = {
                id: 'imported-' + Date.now(),
                name: projectData.name,
                location: projectData.location || projectData.client || 'Lokalizacja zaimportowana',
                icon: '📥',
                status: 'imported',
                statusText: '🟢 ZAIMPORTOWANY',
                surface: projectData.surface || '0m²',
                client: projectData.client || 'Zaimportowany klient',
                taskCount: projectData.tasks ? projectData.tasks.length : 0,
                contact: '+48123456789',
                contactName: 'Kontakt',
                gradient: 'linear-gradient(135deg, #56ab2f 0%, #a8e6cf 100%)',
                imported: true,
                importedFrom: importType,
                categories: {}
            };
            
            // Convert tasks to categories
            if (projectData.tasks) {
                const categoriesMap = {};
                
                projectData.tasks.forEach(task => {
                    const category = task.category || 'główne';
                    if (!categoriesMap[category]) {
                        categoriesMap[category] = {
                            name: category.charAt(0).toUpperCase() + category.slice(1),
                            tasks: []
                        };
                    }
                    categoriesMap[category].tasks.push(task.name);
                });
                
                newProject.categories = categoriesMap;
            }
            
            // Add to projects array
            projects.push(newProject);
            
            // Auto-save after adding project
            autoSave();
            
            // Re-render dashboard
            renderDashboard();
            
            let successMessage = `✅ Projekt "${projectData.name}" został zaimportowany pomyślnie!\n\n`;
            successMessage += `📊 Zadań: ${newProject.taskCount}\n`;
            if (projectData.client) successMessage += `👥 Klient: ${projectData.client}\n`;
            if (projectData.surface) successMessage += `📐 Powierzchnia: ${projectData.surface}\n`;
            successMessage += `\nNowy projekt pojawił się na dashboardzie jako oddzielny kafelek.`;
            
            alert(successMessage);
        }
        
        function parseCSVLine(line) {
            const result = [];
            let current = '';
            let inQuotes = false;
            
            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                
                if (char === '"') {
                    inQuotes = !inQuotes;
                } else if (char === ',' && !inQuotes) {
                    result.push(current);
                    current = '';
                } else {
                    current += char;
                }
            }
            
            result.push(current);
            return result;
        }
        
        function determineCategory(taskName) {
            const task = taskName.toLowerCase();
            
            if (task.includes('pakowanie') || task.includes('rozładunek') || task.includes('stanowisk')) {
                return 'przygotowania';
            } else if (task.includes('szlifowanie') || task.includes('odkurzanie') || task.includes('powierzchni')) {
                return 'przygotowanie-podloza';
            } else if (task.includes('gruntowanie') || task.includes('wylanie') || task.includes('koloru') || task.includes('żywic')) {
                return 'aplikacja-zywic';
            } else if (task.includes('oklejanie') || task.includes('zabezpieczeń') || task.includes('malowanie')) {
                return 'wykończenie';
            } else {
                return 'inne';
            }
        }
    </script>
</body>
</html>
